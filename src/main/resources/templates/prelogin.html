<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OAuth2 PKCE SPA Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    code { background: #f2f2f2; padding: 2px 4px; border-radius: 4px; }
    #token { white-space: pre-wrap; background: #fafafa; padding: 10px; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>OAuth2 PKCE SPA Demo</h2>
  <button id="loginBtn">Login with Auth Server</button>
  <h3>Token Response</h3>
  <pre id="token">(none yet)</pre>

  <script>
    const AUTH_SERVER = 'https://localhost:8443';
    const CLIENT_ID = 'spa-client';
    const REDIRECT_URI = window.location.origin + window.location.pathname; // this page
    const SCOPE = 'payments';

    function base64urlencode(str) {
      return btoa(String.fromCharCode.apply(null, new Uint8Array(str)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    async function generatePKCE() {
      const random = new Uint8Array(32);
      crypto.getRandomValues(random);
      const code_verifier = base64urlencode(random);
      const digest = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(code_verifier));
      const code_challenge = base64urlencode(digest);
      return { code_verifier, code_challenge };
    }

    function redirectToAuth(code_challenge, state) {
      const authUrl = new URL(AUTH_SERVER + '/oauth2/authorize');
      authUrl.search = new URLSearchParams({
        response_type: 'code',
        client_id: CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        scope: SCOPE,
        state,
        code_challenge,
        code_challenge_method: 'S256'
      });
      window.location = authUrl.toString();
    }

    async function exchangeCodeForToken(code, code_verifier) {
      const body = new URLSearchParams({
        grant_type: 'authorization_code',
        code,
        redirect_uri: REDIRECT_URI,
        code_verifier,
        client_id: CLIENT_ID
      });

      const resp = await fetch(AUTH_SERVER + '/oauth2/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      const data = await resp.json();
      document.getElementById('token').textContent = JSON.stringify(data, null, 2);
    }

    async function main() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');

      if (code) {
        const storedState = sessionStorage.getItem('pkce_state');
        const code_verifier = sessionStorage.getItem('pkce_code_verifier');
        if (state !== storedState) {
          alert('State mismatch! Possible CSRF.');
          return;
        }
        await exchangeCodeForToken(code, code_verifier);
        sessionStorage.removeItem('pkce_code_verifier');
        sessionStorage.removeItem('pkce_state');
        window.history.replaceState({}, document.title, window.location.pathname);
        return;
      }

      document.getElementById('loginBtn').onclick = async () => {
        const { code_verifier, code_challenge } = await generatePKCE();
        const state = crypto.randomUUID();
        sessionStorage.setItem('pkce_code_verifier', code_verifier);
        sessionStorage.setItem('pkce_state', state);
        redirectToAuth(code_challenge, state);
      };
    }

    main();
  </script>
</body>
</html>
